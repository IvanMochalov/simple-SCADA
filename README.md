# Система диспетчерского управления и сбора данных для технологических объектов управления

Система для работы с Modbus RTU устройствами через COM порты. Аналог ПО MasterOPC Universal Modbus Server.

## Технологии

- **Сервер**: Node.js, Express, WebSocket, modbus-serial, Prisma ORM, SQLite
- **Клиент**: React, Vite, WebSocket

## Структура проекта

```
diplom2/
├── server/          # Node.js сервер
│   ├── src/
│   │   ├── index.js              # Точка входа сервера
│   │   ├── modbus/
│   │   │   └── ModbusManager.js  # Менеджер Modbus соединений
│   │   └── routes/               # REST API маршруты
│   └── prisma/
│       └── schema.prisma         # Схема базы данных
└── client/         # React клиент
    └── src/
        ├── components/           # React компоненты
        └── context/              # React контексты
```

## Установка

### 1. Установка зависимостей

```bash
# В корневой директории
npm install

# Или установить отдельно для сервера и клиента
cd server && npm install
cd ../client && npm install
```

### 2. Настройка базы данных

```bash
cd server
npx prisma generate
npx prisma migrate dev --name init
```

### 3. Запуск

#### Вариант 1: Запуск сервера и клиента отдельно

```bash
# Терминал 1 - Сервер
cd server
npm run dev

# Терминал 2 - Клиент
cd client
npm run dev
```

#### Вариант 2: Запуск через корневой package.json (если установлен concurrently)

```bash
npm run dev
```

Сервер будет доступен на `http://localhost:3001`
Клиент будет доступен на `http://localhost:5173`

## Использование

### Создание конфигурации

1. **Создать узел связи (COM порт)**
    - Название: например, "COM RTU MASTER"
    - COM порт: например, "COM3"
    - Скорость: 9600 бод
    - Биты данных: 8
    - Стоп-биты: 1
    - Четность: Нет

2. **Добавить устройство**
    - Название: например, "trm"
    - Адрес Modbus: 17 (0x11)
    - Время ответа: 1000 мс
    - Период опроса: 1000 мс

3. **Добавить тег**
    - Название: например, "темп"
    - Адрес регистра: 1 (0x0001)
    - Тип регистра: HOLDING_REGISTER
    - Тип данных в устройстве: int16
    - Тип данных в сервере: int32
    - Тип доступа: ReadOnly

### Просмотр данных

- **Конфигурация**: Управление узлами связи, устройствами и тегами
- **Реальное время**: Отображение текущих значений тегов с обновлением через WebSocket
- **История**: Просмотр исторических данных (собираются каждую минуту)

## Особенности

- Реальное время обновление значений тегов через WebSocket
- Автоматический сбор исторических данных каждую минуту
- Отображение статуса устройств (подключено/отключено/ошибка)
- Древовидная структура: Узлы связи → Устройства → Теги
- Поддержка различных типов регистров Modbus (Holding, Input, Coil, Discrete Input)

## API

### REST API

- `GET /api/connections` - Получить все узлы связи
- `GET /api/connections/:id` - Получить узел связи
- `POST /api/connections` - Создать узел связи
- `PUT /api/connections/:id` - Обновить узел связи
- `DELETE /api/connections/:id` - Удалить узел связи

- `GET /api/devices` - Получить все устройства
- `POST /api/devices` - Создать устройство
- `GET /api/devices/:id` - Получить устройство
- `PUT /api/devices/:id` - Обновить устройство
- `DELETE /api/devices/:id` - Удалить устройство
- `POST /api/devices/:id/reconnect` - Переподключить устройство

- `GET /api/tags` - Получить все теги
- `POST /api/tags` - Создать тег
- `PUT /api/tags/:id` - Обновить тег
- `DELETE /api/tags/:id` - Удалить тег

- `GET /api/history` - Получить исторические данные
- `GET /api/history/tag/:tagId` - Получить историю для тега
- `GET /api/history/device/:deviceId` - Получить историю для устройства

### WebSocket

Подключение: `ws://localhost:3001`

Сообщения от сервера:

- `{ type: 'state', data: { nodes: [...] } }` - Текущее состояние системы
- `{ type: 'tagValues', deviceId: '...', data: { tagId: { value, timestamp } } }` - Обновление значений тегов

## Примечания

- Убедитесь, что COM порт не используется другими приложениями
- На Windows может потребоваться запуск с правами администратора для доступа к COM портам
- Исторические данные собираются каждую минуту для всех активных тегов подключенных устройств
